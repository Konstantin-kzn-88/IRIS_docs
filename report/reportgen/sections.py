# Вещества
SUBSTANCE_SECTIONS = [
    ("Основные сведения", [
        ("name", "Наименование вещества (вид)"),
        ("formula", "Химическая формула"),
    ]),
    ("Состав", [
        ("composition_json", "Состав опасного вещества"),
    ]),
    ("Свойства вещества", [
        ("physical_json", "Физические свойства"),
    ]),
    ("Взрывоопасность", [
        ("explosion_json", "Взрыво- и пожароопасность"),
    ]),
    ("Токсичность", [
        ("toxicity_json", "Токсическая опасность"),
    ]),
    ("Дополнительная информация", [
        ("reactivity", "Реакционная способность"),
        ("odor", "Запах"),
        ("corrosiveness", "Коррозионная активность"),
        ("precautions", "Меры предосторожности"),
        ("impact", "Воздействие на людей и окружающую среду, в том числе от поражающих факторов аварии"),
        ("protection", "Средства индивидуальной и коллективной защиты"),
        ("neutralization_methods", "Методы перевода вещества в безвредное состояние"),
        ("first_aid", "Меры первой помощи пострадавшим от воздействия поражающих факторов при аварии"),
    ]),
]

# Оборудование (id и substance_id не включаем)
EQUIPMENT_SECTIONS = [
    ("Общие сведения", [
        ("equipment_name", "Наименование оборудования"),
        ("hazard_component", "Составляющая ОПО"),
        ("phase_state", "Фазовое состояние вещества"),
        ("equipment_type", "Тип оборудования"),
        ("coord_type", "Тип координат"),
        ("coordinates_json", "Координаты"),
    ]),
    ("Геометрия и объём", [
        ("length_m", "Длина (трубопровод), м"),
        ("diameter_mm", "Диаметр (трубопровод), мм"),
        ("wall_thickness_mm", "Толщина стенки (трубопровод), мм"),
        ("volume_m3", "Объём (емкостное оборудование), м³"),
        ("fill_fraction", "Степень заполнения (емкостное оборудование)"),
    ]),
    ("Режим", [
        ("pressure_mpa", "Давление, МПа"),
        ("substance_temperature_c", "Температура вещества, °C"),
    ]),
    ("Разлив и испарение", [
        ("spill_coefficient", "Коэффициент разлива (на свободную поверхность)"),
        ("spill_area_m2", "Площадь разлива (прогнозируемая), м²"),
        ("shutdown_time_s", "Время отключения оборудования, с"),
        ("evaporation_time_s", "Время испарения вещества из пролива, с"),
    ]),
    ("Поражение персонала", [
        ("possible_dead", "Возможные погибшие, чел."),
        ("possible_injured", "Возможные пострадавшие, чел."),
    ]),
]


def _format_pf_zones(calc_row_tuple):
    """
    Формирует многострочный текст зон поражающих факторов.
    calc_row_tuple — tuple из get_calculation_row_for_top_scenario()
    """
    if calc_row_tuple is None:
        return "—"

    (
        q_10_5, q_7_0, q_4_2, q_1_4,
        p_70, p_28, p_14, p_5, p_2,
        l_f, d_f, r_nkpr, r_vsp, l_pt, p_pt,
        q_600, q_320, q_220, q_120,
        s_t
    ) = calc_row_tuple

    lines = []

    def add_m(val, text):
        if val is not None:
            lines.append(f"{text} {float(val):.1f} м")

    def add_m2(val, text):
        if val is not None:
            lines.append(f"{text} {float(val):.1f} м2")

    # Тепловое излучение (кВт/м2)
    add_m(q_10_5, "непереносимая боль через 3–5 с (10,5 кВт/м2)")
    add_m(q_7_0,  "непереносимая боль через 20–30 с (7,0 кВт/м2)")
    add_m(q_4_2,  "безопасно для человека в брезентовой одежде (4,2 кВт/м2)")
    add_m(q_1_4,  "без негативных последствий длительно (1,4 кВт/м2)")

    # Избыточное давление (кПа)
    add_m(p_70, "тяжёлые повреждения, здание подлежит сносу (ΔР = 70 кПа)")
    add_m(p_28, "средние повреждения зданий (ΔР = 28 кПа)")
    add_m(p_14, "разрушение оконных проёмов, ЛСК (ΔР = 14 кПа)")
    add_m(p_5,  "нижний порог повреждения человека (ΔР = 5 кПа)")
    add_m(p_2,  "частичное разрушение остекления (ΔР = 2 кПа)")

    # Факел / горение / токсодозы
    add_m(l_f,   "длина факела")
    add_m(d_f,   "ширина факела")
    add_m(r_nkpr, "радиус НКПР")
    add_m(r_vsp,  "радиус пожара-вспышки")
    add_m(l_pt,   "радиус зоны смертельной токсодозы")
    add_m(p_pt,   "радиус зоны пороговой токсодозы")

    # Тепловая доза (кДж/м2)
    add_m(q_600, "смертельное поражение (Q=600 кДж/м2)")
    add_m(q_320, "ожоги 3-й степени (Q=320 кДж/м2)")
    add_m(q_220, "ожоги 2-й степени (Q=220 кДж/м2)")
    add_m(q_120, "ожоги 1-й степени (Q=120 кДж/м2)")

    # Пролив
    add_m2(s_t, "площадь пролива опасного вещества")

    return "\n".join(lines) if lines else "—"


def _detect_method_text(calc_row_tuple):
    """
    Возвращает текст(ы) методик расчёта по правилам:
    - если q_1_4 или l_f или r_vsp или q_120 != None -> МЧС №533
    - если p_2 != None -> РБ взрывов ТВС №412
    - если s_t или p_pt != None -> РБ моделирования выбросов №385
    """
    if calc_row_tuple is None:
        return "—"

    (
        q_10_5, q_7_0, q_4_2, q_1_4,
        p_70, p_28, p_14, p_5, p_2,
        l_f, d_f, r_nkpr, r_vsp, l_pt, p_pt,
        q_600, q_320, q_220, q_120,
        s_t
    ) = calc_row_tuple

    methods = []

    # Пожарный риск (МЧС №533)
    if (q_1_4 is not None) or (l_f is not None) or (r_vsp is not None) or (q_120 is not None):
        methods.append(
            "Методика определения расчетных величин пожарного риска на производственных объектах. "
            "Утверждена приказом МЧС РФ от 26.06.2024 № 533, зарегистрировано в Минюсте от 17.08.2009 г. № 14541"
        )

    # Взрывы ТВС (РТН №412)
    if p_2 is not None:
        methods.append(
            "Руководство по безопасности «Методика оценки последствий аварийных взрывов топливно-воздушных смесей» "
            "(утв. приказом Ростехнадзора от 28.11.2022 г. №412)"
        )

    # Распространение выбросов (РТН №385)
    if (s_t is not None) or (p_pt is not None):
        methods.append(
            "Приказ Федеральной службы по экологическому, технологическому и атомному надзору от 02.11.2022 N 385 "
            "\"Об утверждении Руководства по безопасности \"Методика моделирования распространения аварийных выбросов опасных веществ\""
        )

    return "\n".join(methods) if methods else "—"

