# Вещества
SUBSTANCE_SECTIONS = [
    ("Основные сведения", [
        ("name", "Наименование вещества"),
        ("formula", "Формула / описание"),
    ]),
    ("Состав", [
        ("composition_json", "Состав"),
    ]),
    ("Физические свойства", [
        ("physical_json", "Физические свойства"),
    ]),
    ("Взрыво- и пожароопасность", [
        ("explosion_json", "Взрыво- и пожароопасность"),
    ]),
    ("Токсичность", [
        ("toxicity_json", "Токсичность"),
    ]),
    ("Дополнительная информация", [
        ("reactivity", "Реакционная способность"),
        ("odor", "Запах"),
        ("corrosiveness", "Коррозионная активность"),
        ("precautions", "Меры предосторожности"),
        ("impact", "Воздействие на человека"),
        ("protection", "Средства защиты"),
        ("neutralization_methods", "Методы нейтрализации"),
        ("first_aid", "Первая помощь"),
    ]),
]

# Оборудование (id и substance_id не включаем)
EQUIPMENT_SECTIONS = [
    ("Общие сведения", [
        ("equipment_name", "Наименование оборудования"),
        ("hazard_component", "Опасный элемент"),
        ("phase_state", "Фазовое состояние"),
        ("equipment_type", "Тип оборудования"),
        ("coord_type", "Тип координат"),
        ("coordinates_json", "Координаты"),
    ]),
    ("Геометрия и объём", [
        ("length_m", "Длина, м"),
        ("diameter_mm", "Диаметр, мм"),
        ("wall_thickness_mm", "Толщина стенки, мм"),
        ("volume_m3", "Объём, м³"),
        ("fill_fraction", "Степень заполнения"),
    ]),
    ("Режим", [
        ("pressure_mpa", "Давление, МПа"),
        ("substance_temperature_c", "Температура вещества, °C"),
    ]),
    ("Разлив и испарение", [
        ("spill_coefficient", "Коэффициент разлива"),
        ("spill_area_m2", "Площадь разлива, м²"),
        ("shutdown_time_s", "Время отключения, с"),
        ("evaporation_time_s", "Время испарения, с"),
    ]),
    ("Поражение персонала", [
        ("possible_dead", "Возможные погибшие, чел."),
        ("possible_injured", "Возможные пострадавшие, чел."),
    ]),
]


def _format_pf_zones(calc_row_tuple):
    """
    Формирует многострочный текст зон поражающих факторов.
    calc_row_tuple — tuple из get_calculation_row_for_top_scenario()
    """
    if calc_row_tuple is None:
        return "—"

    (
        q_10_5, q_7_0, q_4_2, q_1_4,
        p_70, p_28, p_14, p_5, p_2,
        l_f, d_f, r_nkpr, r_vsp, l_pt, p_pt,
        q_600, q_320, q_220, q_120,
        s_t
    ) = calc_row_tuple

    lines = []

    def add_m(val, text):
        if val is not None:
            lines.append(f"{text} {float(val):.1f} м")

    def add_m2(val, text):
        if val is not None:
            lines.append(f"{text} {float(val):.1f} м2")

    # Тепловое излучение (кВт/м2)
    add_m(q_10_5, "непереносимая боль через 3–5 с (10,5 кВт/м2)")
    add_m(q_7_0,  "непереносимая боль через 20–30 с (7,0 кВт/м2)")
    add_m(q_4_2,  "безопасно для человека в брезентовой одежде (4,2 кВт/м2)")
    add_m(q_1_4,  "без негативных последствий длительно (1,4 кВт/м2)")

    # Избыточное давление (кПа)
    add_m(p_70, "тяжёлые повреждения, здание подлежит сносу (ΔР = 70 кПа)")
    add_m(p_28, "средние повреждения зданий (ΔР = 28 кПа)")
    add_m(p_14, "разрушение оконных проёмов, ЛСК (ΔР = 14 кПа)")
    add_m(p_5,  "нижний порог повреждения человека (ΔР = 5 кПа)")
    add_m(p_2,  "частичное разрушение остекления (ΔР = 2 кПа)")

    # Факел / горение / токсодозы
    add_m(l_f,   "длина факела")
    add_m(d_f,   "ширина факела")
    add_m(r_nkpr, "радиус НКПР")
    add_m(r_vsp,  "радиус пожара-вспышки")
    add_m(l_pt,   "радиус зоны смертельной токсодозы")
    add_m(p_pt,   "радиус зоны пороговой токсодозы")

    # Тепловая доза (кДж/м2)
    add_m(q_600, "смертельное поражение (Q=600 кДж/м2)")
    add_m(q_320, "ожоги 3-й степени (Q=320 кДж/м2)")
    add_m(q_220, "ожоги 2-й степени (Q=220 кДж/м2)")
    add_m(q_120, "ожоги 1-й степени (Q=120 кДж/м2)")

    # Пролив
    add_m2(s_t, "площадь пролива опасного вещества")

    return "\n".join(lines) if lines else "—"
